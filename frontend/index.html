<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Security Agency Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Example third-party UI library: Flowbite -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-100 text-gray-900">
    <nav class="bg-blue-600 p-4">
      <div class="container mx-auto flex justify-between items-center">
        <h1 class="text-white text-xl font-bold">Security Agency</h1>
        <button
          class="bg-white text-blue-600 px-4 py-2 rounded hover:bg-gray-200"
        >
          Dashboard
        </button>
      </div>
    </nav>

    <main class="container mx-auto mt-10">
      <!-- Request Form -->
      <div class="p-6 bg-white rounded-lg shadow mb-8">
        <h2 class="text-lg font-semibold mb-4">Submit a Request</h2>
        <form id="requestForm" class="space-y-4">
          <div>
            <label for="webAddress" class="block text-sm font-medium text-gray-700">Web Address</label>
            <input type="url" id="webAddress" name="webAddress" required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
          </div>
          <div>
            <label for="notes" class="block text-sm font-medium text-gray-700">Extra Notes / Requests</label>
            <textarea id="notes" name="notes" rows="4"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
          </div>
          <button type="submit"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
            Submit Request
          </button>
        </form>
        <div id="output" class="mt-4 p-4 bg-gray-100 rounded h-64 overflow-y-auto text-sm font-mono"></div>
      </div>

      <div id="dashboard" class="p-6 bg-white rounded-lg shadow mb-8">
        <h2 class="text-lg font-semibold mb-4">Dashboard</h2>
        <div id="liveResults" class="h-64 overflow-y-auto bg-gray-100 p-4 rounded text-sm font-mono"></div>
      </div>

      <div id="recommendations" class="p-6 bg-white rounded-lg shadow mb-8">
        <h2 class="text-lg font-semibold mb-4">AI-Powered Recommendations</h2>
        <button onclick="fetchRecommendations()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          Get Recommendations
        </button>
        <div id="recommendationsOutput" class="mt-4 h-64 overflow-y-auto bg-gray-100 p-4 rounded text-sm font-mono"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div
          class="p-6 bg-white rounded-lg shadow hover:shadow-lg transition"
        >
          <h2 class="text-lg font-semibold mb-2">Nmap Agent</h2>
          <p class="text-gray-600">Run network scans and view results.</p>
          <button
            onclick="runScan('nmap')"
            class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
          >
            Run Scan
          </button>
        </div>

        <div
          class="p-6 bg-white rounded-lg shadow hover:shadow-lg transition"
        >
          <h2 class="text-lg font-semibold mb-2">Nikto Agent</h2>
          <p class="text-gray-600">Perform web vulnerability scans.</p>
          <button
            onclick="runScan('nikto')"
            class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
          >
            Run Scan
          </button>
        </div>

        <div
          class="p-6 bg-white rounded-lg shadow hover:shadow-lg transition"
        >
          <h2 class="text-lg font-semibold mb-2">SQLMap Agent</h2>
          <p class="text-gray-600">Detect and exploit SQL injection flaws.</p>
          <button
            onclick="runScan('sqlmap')"
            class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
          >
            Run Scan
          </button>
        </div>
      </div>
    </main>

    <!-- Flowbite JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
    <script>
      async function runScan(agent) {
        const target = prompt("Enter target (e.g., http://example.com):");
        if (!target) return;
        try {
          const response = await fetch("/scan", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ target, agents: [agent] }),
          });
          const data = await response.json();
          const liveResults = document.getElementById("liveResults");
          liveResults.textContent += "\\n[" + agent + "] " + JSON.stringify(data, null, 2);
          liveResults.scrollTop = liveResults.scrollHeight;
        } catch (err) {
          alert("Error: " + err.message);
        }
      }
      document.getElementById("requestForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const webAddress = document.getElementById("webAddress").value;
        const notes = document.getElementById("notes").value;
        const outputDiv = document.getElementById("output");
        outputDiv.textContent = "";

        const response = await fetch("/request", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ webAddress, notes }),
        });

        if (!response.body) {
          outputDiv.textContent = "No response body received.";
          return;
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          outputDiv.textContent += decoder.decode(value, { stream: true });
          outputDiv.scrollTop = outputDiv.scrollHeight;
        }
      });
      async function fetchRecommendations() {
        const scanResults = prompt("Paste scan results JSON:");
        if (!scanResults) return;
        try {
          const response = await fetch("/recommendations", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ scan_results: JSON.parse(scanResults) }),
          });
          const data = await response.json();
          const recDiv = document.getElementById("recommendationsOutput");
          recDiv.textContent = JSON.stringify(data, null, 2);
          recDiv.scrollTop = recDiv.scrollHeight;
        } catch (err) {
          alert("Error: " + err.message);
        }
      }
    </script>
    <h2>Scan History</h2>
    <div id="history"></div>

    <script>
      async function loadHistory() {
        const res = await fetch("/history");
        const history = await res.json();
        const container = document.getElementById("history");
        container.innerHTML = "";
        history.forEach((entry) => {
          const div = document.createElement("div");
          div.innerHTML = `
            <strong>${entry.id}</strong> - ${entry.target} 
            <button onclick="viewResults('${entry.id}')">View Results</button>
          `;
          container.appendChild(div);
        });
      }

      async function viewResults(requestId) {
        const res = await fetch("/results/" + requestId);
        const results = await res.json();
        alert(JSON.stringify(results, null, 2));
      }

      loadHistory();
    </script>
  </body>
</html>
